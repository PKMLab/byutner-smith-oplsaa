#!/usr/bin/env bash
# Generates PVDF beta polymer (CH2CF2)n of any given length (n).
# Open the output (.gro format) in Avogadro and add F or H at the termini if you don't want dangling bonds.
## If you do add terminal H and F make sure you adjust the bondlengths (put values of other C-H and C-F bonds)
## in the CH3 and CF3 groups: `View` > `Properties` > `Bond properties`
# Syntax: polygen <number of monomers> > <outfile.gro>
# Gives .gro format config on stdout and other info at stderr

set -e

which gmx &>/dev/null || { echo "This script requires GROMACS (gmx command) to be installed." && exit;}

mono_conf="$(mktemp -u).pdb"
poly_conf="$(mktemp -u).gro"
semialigned_poly_conf="$(mktemp -u).gro"
aligned_poly_conf="$(mktemp -u).gro"

# Generate a monomer using Avogadro and put the pdb inside `mono_conf`.
# To generate monomer, draw and energy minimize (UFF) a dimer (CH2CF2)2, 
# edit bondlengths and angles to correspond to literature (Zhu et al. 2008, Table 1, doi:10.1016/j.commatsci.2008.03.016),
# align CH2-CH2 line along z and remove a monomer.
cat > "${mono_conf}" << _EOF_
COMPND    PVDF_beta
AUTHOR    GENERATED BY OPEN BABEL 2.3.90
HETATM    1  C   VDF     1       0.000   0.000   0.000  1.00  0.00           C
HETATM    2  C   VDF     1      -0.130   0.776   1.305  1.00  0.00           C
HETATM    3  H   VDF     1      -0.852  -0.659  -0.062  1.00  0.00           H
HETATM    4  H   VDF     1       0.972  -0.463  -0.076  1.00  0.00           H
HETATM    5  F   VDF     1      -1.346   1.349   1.234  1.00  0.00           F
HETATM    6  F   VDF     1       0.820   1.726   1.233  1.00  0.00           F
CONECT    1    2    3    4
CONECT    2    1    5    6
CONECT    3    1
CONECT    4    1
CONECT    5    2
CONECT    6    2
MASTER        0    0    0    0    0    0    0    0    6    0    6    0
END
_EOF_

gmx genconf -o "${poly_conf}" -f "${mono_conf}" -nbox 1 1 "${1}" -dist 0 0 0.256 -norot -renumber yes 1>&2
# Align principal axes of a single molecule - long axis along z and C-F-F bisector (dipole) along Y
  gmx editconf -princ -rotate 0 90 0 -o "${semialigned_poly_conf}" -f "${poly_conf}" 1>&2 <<< '2' # Still one rotation needed
  gmx editconf -rotate 0 0 90 -o "${aligned_poly_conf}" -f "${semialigned_poly_conf}" 1>&2 <<< '2' 
# <<< '0' above makes script non-interactive

head -n -1 "${aligned_poly_conf}" && echo 0.0 0.0 0.0 # Otherwise boxlength along z is non-zero making avogadro fail when displaying .gro
rm -f "${poly_conf}" "${mono_conf}" "${aligned_poly_conf}" "${semialigned_poly_conf}"
